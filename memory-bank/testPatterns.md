# pekko-persistence-effector テスト戦略と設計思想

## テスト戦略の目的と階層

pekko-persistence-effector のテスト戦略は、ライブラリの信頼性と堅牢性を多角的に保証することを目的としています。以下の階層でテストを実施しています。

1.  **単体テスト (Unit Tests):** `SnapshotCriteria` や `RetentionCriteria` など、独立して動作するコンポーネントの内部ロジックを検証します。これにより、個々の部品が期待通りに機能することを確認します。
2.  **統合テスト (Integration Tests):** `PersistenceEffector` と主アクター（テスト内では `Behavior` で表現）が連携して動作することを検証します。イベントの永続化、状態の復元、スナップショットの取得、コールバックの実行など、主要な機能が相互作用するシナリオをテストします。
3.  **モード横断テスト (Cross-Mode Tests):** 同じテストケースを `InMemoryEffector` と `DefaultPersistenceEffector` (実際の永続化バックエンドを使用) の両方のモードで実行します。これは、永続化メカニズムの違いによらず、ライブラリのコア機能が一貫して動作することを保証するために極めて重要です。
4.  **サンプル実装テスト (Example Implementation Tests):** `BankAccountAggregate` のような具体的なユースケースに基づいたテストを実施します。これにより、ライブラリが実際のアプリケーションシナリオで正しく利用でき、期待される結果をもたらすことを確認します。

## テスト基盤: なぜ `PersistenceEffectorTestBase` があるのか？

`PersistenceEffectorTestBase` は、モード横断テストを実現するための抽象基盤クラスです。

- **目的:**
    - **テストコードの再利用:** InMemory モードと Persisted モードで共通するテストロジック（イベント永続化の基本動作、状態復元など）をこの基底クラスに集約し、コードの重複を避けます。
    - **一貫したテストスイート:** サブクラス (`InMemoryEffectorSpec`, `PersistedEffectorSpec`) は、テスト対象の `PersistenceMode` を指定するだけで、基底クラスで定義された共通テストスイートを実行できます。これにより、両モードで同じ観点のテストが実施されることを保証します。
    - **設定の共通化:** `ActorTestKit` の設定や、テストで共通して利用するヘルパーメソッドなどを集約します。

この基盤があることで、新しいテストケースを追加する際に、両方のモードでの動作を効率的に検証できます。

## 主要なテスト観点と「なぜ」

テストケースは、ライブラリのコア機能と設計上の重要な側面をカバーするように設計されています。

- **状態の復元:** アクターが起動または再起動した際に、永続化されたイベントに基づいて正しく状態が復元されるか。これはイベントソーシングの基本であり、最も重要な検証項目の一つです。
- **イベントの永続化:** 単一または複数のイベントが、要求通りに永続化されるか。永続化完了後に期待されるコールバックが実行されるかも含めて検証します。
- **アクター停止・再起動後の状態復元:** アクターが一度停止し、同じ `persistenceId` で再起動した場合でも、以前の状態が正確に復元されるか。永続化メカニズムが正しく機能していることを保証します。
- **スナップショット機能:** スナップショットが設定された基準 (`SnapshotCriteria`) に従って取得され、永続化されるか。また、スナップショットからの状態復元が正しく行われるかも検証します。
- **保持ポリシー (`RetentionCriteria`):** 古いイベントやスナップショットが、設定された保持ポリシーに従って削除されるか。ストレージ効率に関わる重要な機能です。

## InMemory モード特有のテスト: なぜ必要か？

`InMemoryEffector` はデータベースアクセスを行わないため、`DefaultPersistenceEffector` とは異なる側面からのテストが必要です。

- **`getState` メソッドの検証:** `InMemoryEffector` は、テストやデバッグ目的で現在の内部状態に同期的にアクセスする `getState` メソッドを提供します。このメソッドが期待通りに動作するかを検証します。
- **`applyEvent` の二重実行防止:** `InMemoryEffector` は、イベント永続化時に内部状態を直接更新します。この際、`PersistenceEffectorConfig` で渡された `applyEvent` 関数が意図せず二重に呼び出されないこと（永続化時の内部更新と、主アクター側での状態更新の重複がないこと）を確認する必要があります。これは、`DefaultPersistenceEffector` ではリカバリー時にのみ `applyEvent` が内部的に使用されるため、異なる検証ポイントとなります。

これらのテストにより、InMemory モードが開発やテスト支援という目的に沿って、正しくかつ効率的に動作することを確認します。

## テスト実装パターンとその意図

テストコードには、アクターテスト特有のパターンが用いられています。

- **テスト識別子の一意性確保 (UUID):** 各テストケースで `persistenceId` に UUID を含めることで、テスト間の状態の衝突を防ぎます。特に、テストが並列実行される可能性がある場合や、クリーンアップが不完全な場合に重要です。
- **`eventually` パターン:** アクターの処理（メッセージ受信、イベント永続化、コールバック実行）は非同期に行われるため、期待する状態やメッセージ受信を即座にアサートできません。`eventually` を使用して、一定時間内に期待する条件が満たされるまで待機し、非同期性を考慮した検証を行います。
- **テスト前提条件のスキップ (`assume`):** 特定のテスト（例: スナップショット関連）が、設定フラグ (`runSnapshotTests`) によって実行されるべきか判断し、不要な場合はスキップします。これにより、テストスイート全体の実行時間を最適化したり、特定の環境下でのみテストを実行したりできます。
- **メッセージの収集と検証:** アクターからの応答や通知メッセージを `TestProbe` や `ArrayBuffer` などで収集し、テストの最後にその内容や順序を検証します。これは、アクターの振る舞いを確認する基本的な方法です。
- **テスト用の型変換やキャスト (`@unchecked`):** テストコード内で、収集したメッセージの型を検証済みとして安全にキャストするために `@unchecked` を使うことがあります。これは、テストの可読性を保ちつつ、特定のメッセージ型であることを前提としたアサーションを行うためです。

## BankAccount サンプルのテスト: なぜ重要か？

`BankAccountAggregateSpec` のようなサンプル実装に基づいたテストは、ライブラリが実際のユースケースでどのように機能するかを示す上で重要です。

- **実用性の検証:** 単純な `TestState`/`TestEvent` だけでなく、より具体的なドメイン（銀行口座）における一連の操作（開設、入金、出金、残高照会）を通じて、ライブラリが実用的なシナリオで問題なく動作することを確認します。
- **利用例の提示:** これらのテストは、ライブラリ利用者が自身の実装でどのようにテストを書けばよいかの具体的な例としても機能します。

## テスト後のクリーンアップ: なぜ必要か？

特に `InMemoryEventStore` を使用する場合、テストケース間で状態が共有されてしまうため、各テストの後（またはスイートの後）に `InMemoryEventStore.clear()` を呼び出して状態をリセットする必要があります。これにより、テストケースの独立性が保たれ、他のテストの結果に影響されることなく、各テストがクリーンな状態で開始されることを保証します。

## まとめ: テスト戦略がもたらすもの

pekko-persistence-effector の多層的なテスト戦略は、以下の価値を提供します。

1.  **信頼性の向上:** 様々な角度からのテストにより、ライブラリのバグを早期に発見し、修正することができます。
2.  **保守性の確保:** 回帰テストとして機能し、将来のコード変更が既存の機能を破壊しないことを保証します。
3.  **設計の健全性:** テスト容易性を考慮した設計（例: `PersistenceEffectorTestBase`）は、ライブラリ自体のモジュール性や関心の分離を促進します。
4.  **利用者の安心感:** 包括的なテストスイートは、ライブラリ利用者に安定性と信頼性に対する安心感を与えます。
